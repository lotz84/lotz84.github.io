<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Parsecで計算機を書いてみた</title>
        <meta name="viewport" content="width=device-width" />
        <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lora" />
        <link rel="stylesheet" href="../css/kube.min.css" />
        <link rel="stylesheet" href="../css/prism.css" />
        <link rel="stylesheet" href="../css/main.css" />
        <link rel="stylesheet" href="../font/octicons.css" />
        <script type="text/javascript" src="../js/prism.js"></script>
    </head>
    <body>
        <div class="units-row units-padding">
            <div class="unit-20 sidemenu">
                <h1><a href="../">flip map <img src="../img/samurai.png" style="margin:-15px 0 0 -30px;width:60px"></a></h1>
                <p><a href="https://placekitten.com/"><img src="https://placekitten.com/g/200/160"></a></p>
                <h2>Index</h2>
                <ul>
                    <li><a href="../about"><span class="octicon octicon-person"></span> About</a></li>
                    <li><a href="../posts"><span class="octicon octicon-file-text"></span> Blog</a></li>
                    <li><a href="https://github.com/lotz84" target="blank_"><span class="octicon octicon-mark-github"></span> Github</a></li>
                    <li><a href="https://twitter.com/lotz84_" target="blank_"><span class="octicon octicon-mention"></span> Twitter</a></li>
                    <li><a href="../feed.xml" target="blank_"><span class="octicon octicon-rss"></span> RSS</a></li>
                </ul>
            </div>
            <div class="unit-80 entry-body-main">
                <h1><a href="../posts/write-calculator-using-parsec">Parsecで計算機を書いてみた</a></h1>
<p>2015/02/10</p>
<p>Parsec に入門してみました。 構文解析の難しいことは知らずプログラムを書くのも始めてだったのですが、思っていたより全然簡単にかけたのでParsecに感動しています。 勉強のついでにメモとして動くパーサーを並べていきます。</p>
<blockquote class="twitter-tweet" lang="ja">
<p>
Haskell 界隈はParsec持ち上げ過ぎやろって思ってたけど使ってみたらやっぱりParsecマジ最高
<a href="https://t.co/USvgvKLv5p">https://t.co/USvgvKLv5p</a>
</p>
— こひにぶく (<span class="citation">@lotz84_</span>) 2015, 2月 10
</blockquote>
<p>勉強途中なので非効率な実装もあると思いますが、気づいたら随時更新していくつもりです。</p>
<h2 id="四則演算">四則演算</h2>
<h3 id="section">1+2+3</h3>
<ul>
<li>数字: 一桁</li>
<li>演算子: <code>+</code> のみ</li>
<li>空白なし</li>
</ul>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Data.Char</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span>
<span class="kw">import </span><span class="dt">Text.Parsec</span>

num <span class="fu">=</span> digitToInt <span class="fu">&lt;$&gt;</span> digit

op <span class="fu">=</span> const (<span class="fu">+</span>) <span class="fu">&lt;$&gt;</span> char <span class="ch">'+'</span>

expr <span class="fu">=</span> num <span class="ot">`chainl1`</span> op

main <span class="fu">=</span> print <span class="fu">$</span> parse expr <span class="st">&quot;&quot;</span> <span class="st">&quot;1+2+3&quot;</span>
<span class="co">-- Right 6</span></code></pre></div>
<h3 id="section-1">1+2-3</h3>
<ul>
<li>数字: 一桁</li>
<li>演算子: <code>+</code>, <code>-</code></li>
<li>空白なし</li>
</ul>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Data.Char</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span>
<span class="kw">import </span><span class="dt">Text.Parsec</span> <span class="kw">hiding</span> ((&lt;|&gt;))

num <span class="fu">=</span> digitToInt <span class="fu">&lt;$&gt;</span> digit

op <span class="fu">=</span> (const (<span class="fu">+</span>) <span class="fu">&lt;$&gt;</span> char <span class="ch">'+'</span>) <span class="fu">&lt;|&gt;</span> (const (<span class="fu">-</span>) <span class="fu">&lt;$&gt;</span> char <span class="ch">'-'</span>)

expr <span class="fu">=</span> num <span class="ot">`chainl1`</span> op

main <span class="fu">=</span> print <span class="fu">$</span> parse expr <span class="st">&quot;&quot;</span> <span class="st">&quot;1+2-3&quot;</span>
<span class="co">-- Right 0</span></code></pre></div>
<h3 id="section-2">10+2-3</h3>
<ul>
<li>数字: 自然数</li>
<li>演算子: <code>+</code>, <code>-</code></li>
<li>空白なし</li>
</ul>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Data.Char</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span> <span class="kw">hiding</span> (many)
<span class="kw">import </span><span class="dt">Text.Parsec</span> <span class="kw">hiding</span> ((&lt;|&gt;))

num <span class="fu">=</span> <span class="kw">do</span>
  xs <span class="ot">&lt;-</span> many <span class="fu">$</span> digitToInt <span class="fu">&lt;$&gt;</span> digit
  return <span class="fu">$</span> foldl f <span class="dv">0</span> xs
  <span class="kw">where</span>
  f x y <span class="fu">=</span> x <span class="fu">*</span> <span class="dv">10</span> <span class="fu">+</span> y

op <span class="fu">=</span> (const (<span class="fu">+</span>) <span class="fu">&lt;$&gt;</span> char <span class="ch">'+'</span>) <span class="fu">&lt;|&gt;</span> (const (<span class="fu">-</span>) <span class="fu">&lt;$&gt;</span> char <span class="ch">'-'</span>)

expr <span class="fu">=</span> num <span class="ot">`chainl1`</span> op

main <span class="fu">=</span> print <span class="fu">$</span> parse expr <span class="st">&quot;&quot;</span> <span class="st">&quot;10+2-3&quot;</span>
<span class="co">-- Right 9</span></code></pre></div>
<h3 id="section-3">1.2+2.0+3</h3>
<ul>
<li>数字: 非負実数</li>
<li>演算子: <code>+</code>, <code>-</code></li>
<li>空白なし</li>
</ul>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Data.Char</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span> <span class="kw">hiding</span> (many)
<span class="kw">import </span><span class="dt">Text.Parsec</span> <span class="kw">hiding</span> ((&lt;|&gt;))

<span class="ot">digitToDouble ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Double</span>
digitToDouble <span class="fu">=</span> fromIntegral <span class="fu">.</span> digitToInt

num <span class="fu">=</span> <span class="kw">do</span>
  xs <span class="ot">&lt;-</span> many <span class="fu">$</span> digitToDouble <span class="fu">&lt;$&gt;</span> digit
  dot <span class="ot">&lt;-</span> optionMaybe (char <span class="ch">'.'</span>)
  ys <span class="ot">&lt;-</span> many <span class="fu">$</span> digitToDouble <span class="fu">&lt;$&gt;</span> digit
  return <span class="fu">$</span> foldl f <span class="dv">0</span> xs <span class="fu">+</span> foldl g <span class="dv">0</span> ys
  <span class="kw">where</span>
  f x y <span class="fu">=</span> x <span class="fu">*</span> <span class="dv">10</span> <span class="fu">+</span> y
  g x y <span class="fu">=</span> x <span class="fu">+</span> y <span class="fu">*</span> <span class="fl">0.1</span>

op <span class="fu">=</span> (const (<span class="fu">+</span>) <span class="fu">&lt;$&gt;</span> char <span class="ch">'+'</span>) <span class="fu">&lt;|&gt;</span> (const (<span class="fu">-</span>) <span class="fu">&lt;$&gt;</span> char <span class="ch">'-'</span>)

expr <span class="fu">=</span> num <span class="ot">`chainl1`</span> op

main <span class="fu">=</span> print <span class="fu">$</span> parse expr <span class="st">&quot;&quot;</span> <span class="st">&quot;1.2+2.0-3&quot;</span>
<span class="co">-- Right 0.20000000000000018</span></code></pre></div>
<h3 id="section-4">10 + 2.0 - 3</h3>
<ul>
<li>数字: 非負実数</li>
<li>演算子: <code>+</code>, <code>-</code></li>
<li>空白あり</li>
</ul>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Data.Char</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span> <span class="kw">hiding</span> (many)
<span class="kw">import </span><span class="dt">Text.Parsec</span> <span class="kw">hiding</span> ((&lt;|&gt;))

<span class="ot">digitToDouble ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Double</span>
digitToDouble <span class="fu">=</span> fromIntegral <span class="fu">.</span> digitToInt

symbol xs <span class="fu">=</span> <span class="kw">do</span>
  result <span class="ot">&lt;-</span> string xs
  spaces
  return result

num <span class="fu">=</span> <span class="kw">do</span>
  xs <span class="ot">&lt;-</span> many <span class="fu">$</span> digitToDouble <span class="fu">&lt;$&gt;</span> digit
  dot <span class="ot">&lt;-</span> optionMaybe (char <span class="ch">'.'</span>)
  ys <span class="ot">&lt;-</span> many <span class="fu">$</span> digitToDouble <span class="fu">&lt;$&gt;</span> digit
  spaces
  return <span class="fu">$</span> foldl f <span class="dv">0</span> xs <span class="fu">+</span> foldl g <span class="dv">0</span> ys
  <span class="kw">where</span>
  f x y <span class="fu">=</span> x <span class="fu">*</span> <span class="dv">10</span> <span class="fu">+</span> y
  g x y <span class="fu">=</span> x <span class="fu">+</span> y <span class="fu">*</span> <span class="fl">0.1</span>

op <span class="fu">=</span> (const (<span class="fu">+</span>) <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;+&quot;</span>) <span class="fu">&lt;|&gt;</span> (const (<span class="fu">-</span>) <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;-&quot;</span>)

expr <span class="fu">=</span> <span class="kw">do</span>
  spaces
  num <span class="ot">`chainl1`</span> op

main <span class="fu">=</span> print <span class="fu">$</span> parse expr <span class="st">&quot;&quot;</span> <span class="st">&quot;10 + 2.0 - 3&quot;</span>
<span class="co">-- Right 9.0</span></code></pre></div>
<h3 id="section-5">10 + 2.0 * 3 / 4</h3>
<ul>
<li>数字: 非負実数</li>
<li>演算子: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code></li>
<li>空白あり</li>
</ul>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Data.Char</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span> <span class="kw">hiding</span> (many)
<span class="kw">import </span><span class="dt">Text.Parsec</span> <span class="kw">hiding</span> ((&lt;|&gt;))

<span class="ot">digitToDouble ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Double</span>
digitToDouble <span class="fu">=</span> fromIntegral <span class="fu">.</span> digitToInt

symbol xs <span class="fu">=</span> <span class="kw">do</span>
  result <span class="ot">&lt;-</span> string xs
  spaces
  return result

num <span class="fu">=</span> <span class="kw">do</span>
  xs <span class="ot">&lt;-</span> many <span class="fu">$</span> digitToDouble <span class="fu">&lt;$&gt;</span> digit
  dot <span class="ot">&lt;-</span> optionMaybe (char <span class="ch">'.'</span>)
  ys <span class="ot">&lt;-</span> many <span class="fu">$</span> digitToDouble <span class="fu">&lt;$&gt;</span> digit
  spaces
  return <span class="fu">$</span> foldl f <span class="dv">0</span> xs <span class="fu">+</span> foldl g <span class="dv">0</span> ys
  <span class="kw">where</span>
  f x y <span class="fu">=</span> x <span class="fu">*</span> <span class="dv">10</span> <span class="fu">+</span> y
  g x y <span class="fu">=</span> x <span class="fu">+</span> y <span class="fu">*</span> <span class="fl">0.1</span>

op0 <span class="fu">=</span> (const (<span class="fu">*</span>) <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;*&quot;</span>) <span class="fu">&lt;|&gt;</span> (const (<span class="fu">/</span>) <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;/&quot;</span>)
op1 <span class="fu">=</span> (const (<span class="fu">+</span>) <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;+&quot;</span>) <span class="fu">&lt;|&gt;</span> (const (<span class="fu">-</span>) <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;-&quot;</span>)

expr <span class="fu">=</span> <span class="kw">do</span>
  spaces
  num <span class="ot">`chainl1`</span> op0 <span class="ot">`chainl1`</span> op1

main <span class="fu">=</span> print <span class="fu">$</span> parse expr <span class="st">&quot;&quot;</span> <span class="st">&quot;10 + 2.0 * 3 / 4&quot;</span>
<span class="co">-- Right 11.5</span></code></pre></div>
<h3 id="section-6">(10 + 2.0) * 3 / 4</h3>
<ul>
<li>数字: 非負実数</li>
<li>演算子: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code></li>
<li>空白あり</li>
<li>括弧あり</li>
</ul>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Data.Char</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span> <span class="kw">hiding</span> (many)
<span class="kw">import </span><span class="dt">Text.Parsec</span> <span class="kw">hiding</span> ((&lt;|&gt;))

<span class="ot">digitToDouble ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Double</span>
digitToDouble <span class="fu">=</span> fromIntegral <span class="fu">.</span> digitToInt

symbol xs <span class="fu">=</span> <span class="kw">do</span>
  result <span class="ot">&lt;-</span> string xs
  spaces
  return result

num <span class="fu">=</span> <span class="kw">do</span>
  xs <span class="ot">&lt;-</span> many <span class="fu">$</span> digitToDouble <span class="fu">&lt;$&gt;</span> digit
  dot <span class="ot">&lt;-</span> optionMaybe (char <span class="ch">'.'</span>)
  ys <span class="ot">&lt;-</span> many <span class="fu">$</span> digitToDouble <span class="fu">&lt;$&gt;</span> digit
  spaces
  return <span class="fu">$</span> foldl f <span class="dv">0</span> xs <span class="fu">+</span> foldl g <span class="dv">0</span> ys
  <span class="kw">where</span>
  f x y <span class="fu">=</span> x <span class="fu">*</span> <span class="dv">10</span> <span class="fu">+</span> y
  g x y <span class="fu">=</span> x <span class="fu">+</span> y <span class="fu">*</span> <span class="fl">0.1</span>

parens <span class="fu">=</span> <span class="kw">do</span>
  symbol <span class="st">&quot;(&quot;</span>
  result <span class="ot">&lt;-</span> expr
  symbol <span class="st">&quot;)&quot;</span>
  return result

term <span class="fu">=</span> try parens <span class="fu">&lt;|&gt;</span> num

op0 <span class="fu">=</span> (const (<span class="fu">*</span>) <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;*&quot;</span>) <span class="fu">&lt;|&gt;</span> (const (<span class="fu">/</span>) <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;/&quot;</span>)
op1 <span class="fu">=</span> (const (<span class="fu">+</span>) <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;+&quot;</span>) <span class="fu">&lt;|&gt;</span> (const (<span class="fu">-</span>) <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;-&quot;</span>)

expr <span class="fu">=</span> <span class="kw">do</span>
  spaces
  term <span class="ot">`chainl1`</span> op0 <span class="ot">`chainl1`</span> op1

main <span class="fu">=</span> print <span class="fu">$</span> parse expr <span class="st">&quot;&quot;</span> <span class="st">&quot;(10 + 2.0) * 3 / 4&quot;</span>
<span class="co">-- Right 9.0</span></code></pre></div>
<h2 id="ast">AST</h2>
<p>ここまでは式の文字列から直接計算した結果を返していましたがここでは抽象構文木を生成するようにしてみます。 計算のASTを<code>Expr</code>というデータ型で表し文字列をパースしてデータを作ろうと思います。 実際にやってみると上のソースからほんの少しの修正でASTを作ることができました！</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Data.Char</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span> <span class="kw">hiding</span> (many)
<span class="kw">import </span><span class="dt">Text.Parsec</span> <span class="kw">hiding</span> ((&lt;|&gt;))

<span class="kw">data</span> <span class="dt">Expr</span> <span class="fu">=</span> <span class="dt">Value</span> <span class="dt">Double</span>
          <span class="fu">|</span> <span class="dt">Plus</span> <span class="dt">Expr</span> <span class="dt">Expr</span>
          <span class="fu">|</span> <span class="dt">Minus</span> <span class="dt">Expr</span> <span class="dt">Expr</span>
          <span class="fu">|</span> <span class="dt">Times</span> <span class="dt">Expr</span> <span class="dt">Expr</span>
          <span class="fu">|</span> <span class="dt">Divide</span> <span class="dt">Expr</span> <span class="dt">Expr</span>
          <span class="kw">deriving</span> <span class="dt">Show</span>

<span class="ot">digitToDouble ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Double</span>
digitToDouble <span class="fu">=</span> fromIntegral <span class="fu">.</span> digitToInt

symbol xs <span class="fu">=</span> <span class="kw">do</span>
  result <span class="ot">&lt;-</span> string xs
  spaces
  return result

num <span class="fu">=</span> <span class="kw">do</span>
  xs <span class="ot">&lt;-</span> many <span class="fu">$</span> digitToDouble <span class="fu">&lt;$&gt;</span> digit
  dot <span class="ot">&lt;-</span> optionMaybe (char <span class="ch">'.'</span>)
  ys <span class="ot">&lt;-</span> many <span class="fu">$</span> digitToDouble <span class="fu">&lt;$&gt;</span> digit
  spaces
  return <span class="fu">$</span> <span class="dt">Value</span> <span class="fu">$</span> foldl f <span class="dv">0</span> xs <span class="fu">+</span> foldl g <span class="dv">0</span> ys
  <span class="kw">where</span>
  f x y <span class="fu">=</span> x <span class="fu">*</span> <span class="dv">10</span> <span class="fu">+</span> y
  g x y <span class="fu">=</span> x <span class="fu">+</span> y <span class="fu">*</span> <span class="fl">0.1</span>

parens <span class="fu">=</span> <span class="kw">do</span>
  symbol <span class="st">&quot;(&quot;</span>
  result <span class="ot">&lt;-</span> expr
  symbol <span class="st">&quot;)&quot;</span>
  return result

term <span class="fu">=</span> try parens <span class="fu">&lt;|&gt;</span> num

op0 <span class="fu">=</span> (const <span class="dt">Times</span> <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;*&quot;</span>) <span class="fu">&lt;|&gt;</span> (const <span class="dt">Divide</span> <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;/&quot;</span>)
op1 <span class="fu">=</span> (const <span class="dt">Plus</span>  <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;+&quot;</span>) <span class="fu">&lt;|&gt;</span> (const <span class="dt">Minus</span>  <span class="fu">&lt;$&gt;</span> symbol <span class="st">&quot;-&quot;</span>)

expr <span class="fu">=</span> <span class="kw">do</span>
  spaces
  term <span class="ot">`chainl1`</span> op0 <span class="ot">`chainl1`</span> op1

main <span class="fu">=</span> print <span class="fu">$</span> parse expr <span class="st">&quot;&quot;</span> <span class="st">&quot;1.2+2.0-3&quot;</span>
<span class="co">-- Right (Minus (Plus (Value 1.2) (Value 2.0)) (Value 3.0))</span></code></pre></div>
<div>
    <a href="http://b.hatena.ne.jp/entry/" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加" class="hatena-bookmark-button"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.3";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script><div data-layout="button_count" data-action="like" data-show-faces="false" data-share="false" class="fb-like"></div>
</div>

<div class="hatena-bookmark-marker"></div>

<script type="text/javascript" charset="utf-8" src="http://b.hatena.ne.jp/js/bookmark_blogparts.js"></script>
<script type="text/javascript">
HBBlogParts.commentInsertSelector = [ 'div.hatena-bookmark-marker'];
HBBlogParts.permalinkSelector = [ 'div.entry-body-main h1 a'];
HBBlogParts.permalinkAttribute = 'href';
HBBlogParts.permalinkPathRegexp = /\/posts\/.*\.html/;
</script>

            </div>
        </div>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-38246049-16', 'auto');
            ga('send', 'pageview');
        </script>
    </body>
</html>
